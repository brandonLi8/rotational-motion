# Copyright Â© 2019 Brandon Li. All rights reserved.

#====================================================================================================
#
# IMPORTANT: This file was generated by `grunt generate-heroku-deploy`. This file SHOULD NOT be modified. Your package.json
#            determines the content of this file. See `../grunt-commands/generate.js` for documentation on setup.
#
# IMPORTANT: `grunt generate-heroku-deploy` is a custom command (Found
#            https://github.com/brandonLi8/grunt-config/Gruntfile.js). Your repository's
#            Gruntfile must extend to this Gruntfile to run the command.
#
# Entry point for Heroku deployment. This file create a Github Workflow to check that:
#   (1) Everything is lint free. All source code should be tested before deployed.
#   (2) All tests pass without error. All source code should be tested before deployed.
#   (3) All code is built and compiled.
#
# @author Brandon Li brandon.li820@gmail.com
#
#====================================================================================================

name: deployment                      # tentative workflow name
on:
  push:                               # activate on the push action
    branches:
      - production                    # only activate on the production branch

jobs:
  build:
    name: deploy
    runs-on: ubuntu-latest

    steps:                            # checkout and set up node
    - uses: actions/checkout@v1
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: npm stability             # ensure the stability of npm
      run: |
        npm prune -production=true    # prune - ensure a fresh copy of node_modules
        npm cache clean --f           # clear the cache to ensure validity of node_modules
        npm install                   # install dependencies

    - name: lint                      # ensure all source code is lint-free
      run: grunt eslint --no-cache

    - name: deploy to heroku          # deploy to heroku
      env:
        HEROKU_API_TOKEN: ${{ secrets.HEROKU_API_TOKEN }}
        HEROKU_APP_NAME: "rotational-motion"
      if: github.ref == 'refs/heads/production' && job.status == 'success'
      run: git push https://heroku:$HEROKU_API_TOKEN@git.heroku.com/$HEROKU_APP_NAME.git origin/master:master